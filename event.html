<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»å‹•å ±åèˆ‡ä»»å‹™ç´¯ç©ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* ç™»å…¥ç•Œé¢ */
        .login-screen {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 500px;
            margin: 100px auto;
        }

        .login-screen h1 {
            color: #667eea;
            margin-bottom: 30px;
            text-align: center;
        }

        .login-buttons {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }

        .login-buttons button {
            flex: 1;
            padding: 15px;
            font-size: 16px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .login-buttons button:hover {
            transform: translateY(-2px);
        }

        .btn-admin {
            background: #667eea;
            color: white;
        }

        .btn-user {
            background: #764ba2;
            color: white;
        }

        input[type="text"], input[type="number"], input[type="datetime-local"], textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        /* é ‚éƒ¨å°èˆª */
        .header {
            background: white;
            border-radius: 15px;
            padding: 20px 30px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .header h2 {
            color: #667eea;
        }

        .header .user-info {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        /* ä»»å‹™é€²åº¦ Banner */
        .task-banner {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            color: white;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .task-banner h3 {
            font-size: 24px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-bar-container {
            background: rgba(255,255,255,0.3);
            border-radius: 20px;
            height: 30px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-bar {
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            height: 100%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .achievement-stamp {
            display: inline-block;
            background: #ffd700;
            color: #333;
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: bold;
            margin-top: 10px;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-warning {
            background: #ed8936;
            color: white;
        }

        .btn-secondary {
            background: #a0aec0;
            color: white;
        }

        /* å¡ç‰‡æ¨£å¼ */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s;
            position: relative;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 20px;
            color: #2d3748;
            font-weight: bold;
        }

        .card-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .badge-online {
            background: #bee3f8;
            color: #2c5282;
        }

        .badge-onsite {
            background: #c6f6d5;
            color: #276749;
        }

        .badge-task {
            background: #fbd38d;
            color: #7c2d12;
        }

        .winner-badge {
            background: #ffd700;
            color: #333;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 10px;
        }

        .card-content {
            color: #718096;
            margin: 15px 0;
            line-height: 1.6;
        }

        .card-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        /* ç®¡ç†è€…è¡¨æ ¼ */
        .admin-table {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
        }

        tr:hover {
            background: #f7fafc;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #667eea;
            font-size: 24px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #a0aec0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2d3748;
            font-weight: 600;
        }

        /* éš±è—é¡ */
        .hidden {
            display: none !important;
        }

        /* ç‹€æ…‹æ¨™ç±¤ */
        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-approved {
            background: #d1fae5;
            color: #065f46;
        }

        .status-rejected {
            background: #fee2e2;
            color: #991b1b;
        }

        /* é‡ç½®æŒ‰éˆ• */
        .reset-btn {
            background: #ef4444;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .reset-btn:hover {
            background: #dc2626;
        }

        /* çµ±è¨ˆä¿¡æ¯ */
        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #718096;
            margin-top: 5px;
        }

        .info-text {
            background: #e6fffa;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            color: #234e52;
            border-left: 4px solid #38b2ac;
        }

        .warning-text {
            background: #fffbeb;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            color: #78350f;
            border-left: 4px solid #f59e0b;
        }

        /* é»æ•¸é¡¯ç¤º */
        .points-display {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #333;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 18px;
            display: inline-block;
        }

        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }

        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #555 transparent transparent transparent;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-claim {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #333;
            font-weight: bold;
        }

        .btn-claim:hover:not(:disabled) {
            background: linear-gradient(135deg, #ffed4e 0%, #ffd700 100%);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ç™»å…¥ç•«é¢ -->
        <div id="loginScreen" class="login-screen">
            <h1>ğŸ¯ æ´»å‹•å ±åèˆ‡ä»»å‹™ç³»çµ±</h1>
            <div class="form-group">
                <label>è«‹é¸æ“‡èº«ä»½ï¼š</label>
                <div class="login-buttons">
                    <button class="btn-admin" onclick="loginAsAdmin()">ğŸ‘¨â€ğŸ’¼ ç®¡ç†è€…</button>
                    <button class="btn-user" onclick="showUserLogin()">ğŸ‘¤ ä½¿ç”¨è€…</button>
                </div>
            </div>
            <div id="userLoginForm" class="hidden">
                <div class="form-group">
                    <label>ä½¿ç”¨è€… IDï¼š</label>
                    <input type="text" id="userIdInput" placeholder="è«‹è¼¸å…¥æ‚¨çš„ä½¿ç”¨è€… ID">
                </div>
                <button class="btn btn-primary" style="width: 100%;" onclick="loginAsUser()">ç™»å…¥</button>
            </div>
        </div>

        <!-- ç®¡ç†è€…ä»‹é¢ -->
        <div id="adminScreen" class="hidden">
            <div class="header">
                <h2>ğŸ‘¨â€ğŸ’¼ ç®¡ç†è€…æ§åˆ¶å°</h2>
                <div class="user-info">
                    <button class="btn btn-primary" onclick="showAddEventModal()">â• æ–°å¢æ´»å‹•</button>
                    <button class="reset-btn" onclick="resetAllData()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
                    <button class="btn btn-secondary" onclick="logout()">ç™»å‡º</button>
                </div>
            </div>

            <!-- çµ±è¨ˆå¡ç‰‡ -->
            <div class="stats-card">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalEvents">0</div>
                        <div class="stat-label">ç¸½æ´»å‹•æ•¸</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalRegistrations">0</div>
                        <div class="stat-label">ç¸½å ±åæ•¸</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="pendingApprovals">0</div>
                        <div class="stat-label">å¾…å¯©æ ¸</div>
                    </div>
                </div>
            </div>

            <!-- æ´»å‹•åˆ—è¡¨ -->
            <div id="adminEventsList"></div>
        </div>

        <!-- ä½¿ç”¨è€…ä»‹é¢ -->
        <div id="userScreen" class="hidden">
            <div class="header">
                <h2>ğŸ‘¤ æ­¡è¿ï¼Œ<span id="currentUserId"></span></h2>
                <div class="user-info">
                    <div class="points-display">ğŸ’° é»æ•¸: <span id="userPoints">0</span></div>
                    <button class="btn btn-secondary" onclick="logout()">ç™»å‡º</button>
                </div>
            </div>

            <!-- ä»»å‹™é€²åº¦ Banner -->
            <div id="taskBanner" class="hidden"></div>

            <!-- é€²è¡Œä¸­çš„æ´»å‹• -->
            <div style="margin-bottom: 30px;">
                <h3 style="color: white; margin-bottom: 15px; font-size: 20px;">ğŸ“Œ é€²è¡Œä¸­çš„æ´»å‹•</h3>
                <div id="userEventsList" class="cards-grid"></div>
            </div>

            <!-- æ­·å²æ´»å‹• -->
            <div id="historySection" class="hidden" style="margin-top: 30px;">
                <h3 style="color: white; margin-bottom: 15px; font-size: 20px;">ğŸ“š æ­·å²æ´»å‹•</h3>
                <div id="historyEventsList" class="cards-grid"></div>
            </div>
        </div>
    </div>

    <!-- æ–°å¢/ç·¨è¼¯æ´»å‹• Modal -->
    <div id="eventModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">æ–°å¢æ´»å‹•</h3>
                <button class="close-btn" onclick="closeEventModal()">&times;</button>
            </div>
            <form id="eventForm">
                <input type="hidden" id="editEventId">

                <div class="form-group">
                    <label>æ´»å‹•é¡å‹ï¼š</label>
                    <select id="eventType" onchange="handleEventTypeChange()">
                        <option value="Online">ç·šä¸Šæ´»å‹• (Online)</option>
                        <option value="OnSite">å¯¦é«”æ´»å‹• (OnSite)</option>
                        <option value="Task">ä»»å‹™ç´¯ç© (Task)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>æ´»å‹•æ¨™é¡Œï¼š</label>
                    <input type="text" id="eventTitle" required>
                </div>

                <div class="form-group">
                    <label>æ´»å‹•èªªæ˜ï¼š</label>
                    <textarea id="eventDescription" rows="4"></textarea>
                </div>

                <!-- Online å°ˆå±¬ -->
                <div class="form-group event-field online-field">
                    <label>é€£çµï¼š</label>
                    <input type="text" id="eventLink">
                </div>

                <div class="form-group event-field online-field">
                    <label>å ±åé–‹å§‹æ™‚é–“ï¼š</label>
                    <input type="datetime-local" id="onlineRegistrationStartTime">
                </div>

                <div class="form-group event-field online-field">
                    <label>å ±åçµæŸæ™‚é–“ï¼š</label>
                    <input type="datetime-local" id="onlineRegistrationEndTime">
                </div>

                <div class="form-group event-field online-field">
                    <label>æŠ½çåé¡ï¼š</label>
                    <input type="number" id="drawSlots" min="0" value="0">
                </div>

                <div class="form-group event-field online-field">
                    <label>æŠ½çé–‹å§‹æ™‚é–“ï¼š</label>
                    <input type="datetime-local" id="drawTime">
                </div>

                <!-- OnSite å°ˆå±¬ -->
                <div class="form-group event-field onsite-field">
                    <label>æ´»å‹•åœ°é»ï¼š</label>
                    <input type="text" id="eventLocation">
                </div>

                <div class="form-group event-field onsite-field">
                    <label>å ±åé–‹å§‹æ™‚é–“ï¼š</label>
                    <input type="datetime-local" id="registrationStartTime">
                </div>

                <div class="form-group event-field onsite-field">
                    <label>å ±åçµæŸæ™‚é–“ï¼š</label>
                    <input type="datetime-local" id="registrationEndTime">
                </div>

                <div class="form-group event-field onsite-field">
                    <label>ç°½åˆ°é–‹å§‹æ™‚é–“ï¼š</label>
                    <input type="datetime-local" id="checkinStartTime">
                </div>

                <div class="form-group event-field onsite-field">
                    <label>ç°½åˆ°çµæŸæ™‚é–“ï¼š</label>
                    <input type="datetime-local" id="checkinEndTime">
                </div>

                <!-- Task å°ˆå±¬ -->
                <div class="form-group event-field task-field hidden">
                    <label>ä»»å‹™é–‹å§‹æ™‚é–“ï¼š</label>
                    <input type="datetime-local" id="taskStartTime">
                </div>

                <div class="form-group event-field task-field hidden">
                    <label>ä»»å‹™çµæŸæ™‚é–“ï¼š</label>
                    <input type="datetime-local" id="taskEndTime">
                </div>

                <div class="form-group event-field task-field hidden">
                    <label>ç›®æ¨™åƒåŠ æ¬¡æ•¸ï¼š</label>
                    <input type="number" id="taskGoal" min="1" value="5">
                </div>

                <div class="form-group event-field task-field hidden">
                    <label>çå‹µé»æ•¸ï¼š</label>
                    <input type="number" id="taskPoints" min="0" value="100">
                </div>

                <div id="taskWarning" class="warning-text hidden">
                    âš ï¸ ç³»çµ±å·²å­˜åœ¨ä¸€å€‹ä»»å‹™ç´¯ç©æ´»å‹•ï¼Œç›®å‰ç„¡æ³•æ–°å¢ç¬¬äºŒå€‹ã€‚
                </div>

                <div class="card-actions">
                    <button type="submit" class="btn btn-primary">å„²å­˜</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEventModal()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- å ±åæ˜ç´° Modal -->
    <div id="registrationsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>å ±åæ˜ç´°</h3>
                <button class="close-btn" onclick="closeRegistrationsModal()">&times;</button>
            </div>
            <div id="registrationsContent"></div>
        </div>
    </div>

    <!-- æ´»å‹•è©³æƒ… Modal -->
    <div id="eventDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="detailTitle"></h3>
                <button class="close-btn" onclick="closeEventDetailModal()">&times;</button>
            </div>
            <div id="eventDetailContent"></div>
        </div>
    </div>

    <script>
        // ==================== è³‡æ–™æ¨¡å‹ ====================
        let currentUser = null;
        let currentRole = null;

        // åˆå§‹åŒ– LocalStorage
        function initStorage() {
            if (!localStorage.getItem('events')) {
                localStorage.setItem('events', JSON.stringify([]));
            }
            if (!localStorage.getItem('registrations')) {
                localStorage.setItem('registrations', JSON.stringify([]));
            }
            if (!localStorage.getItem('userPoints')) {
                localStorage.setItem('userPoints', JSON.stringify({}));
            }
            if (!localStorage.getItem('taskClaims')) {
                localStorage.setItem('taskClaims', JSON.stringify({}));
            }
        }

        function getEvents() {
            return JSON.parse(localStorage.getItem('events') || '[]');
        }

        function saveEvents(events) {
            localStorage.setItem('events', JSON.stringify(events));
        }

        function getRegistrations() {
            return JSON.parse(localStorage.getItem('registrations') || '[]');
        }

        function saveRegistrations(registrations) {
            localStorage.setItem('registrations', JSON.stringify(registrations));
        }

        function getUserPoints(userId) {
            const points = JSON.parse(localStorage.getItem('userPoints') || '{}');
            return points[userId] || 0;
        }

        function saveUserPoints(userId, points) {
            const allPoints = JSON.parse(localStorage.getItem('userPoints') || '{}');
            allPoints[userId] = points;
            localStorage.setItem('userPoints', JSON.stringify(allPoints));
        }

        function getTaskClaims(userId) {
            const claims = JSON.parse(localStorage.getItem('taskClaims') || '{}');
            return claims[userId] || {};
        }

        function saveTaskClaim(userId, taskId) {
            const claims = JSON.parse(localStorage.getItem('taskClaims') || '{}');
            if (!claims[userId]) claims[userId] = {};
            claims[userId][taskId] = true;
            localStorage.setItem('taskClaims', JSON.stringify(claims));
        }

        // ==================== ç™»å…¥ç³»çµ± ====================
        function loginAsAdmin() {
            currentRole = 'admin';
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('adminScreen').classList.remove('hidden');
            renderAdminScreen();
        }

        function showUserLogin() {
            document.getElementById('userLoginForm').classList.remove('hidden');
        }

        function loginAsUser() {
            const userId = document.getElementById('userIdInput').value.trim();
            if (!userId) {
                alert('è«‹è¼¸å…¥ä½¿ç”¨è€… ID');
                return;
            }
            currentUser = userId;
            currentRole = 'user';
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('userScreen').classList.remove('hidden');
            document.getElementById('currentUserId').textContent = userId;
            renderUserScreen();
        }

        function logout() {
            currentUser = null;
            currentRole = null;
            document.getElementById('adminScreen').classList.add('hidden');
            document.getElementById('userScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('userLoginForm').classList.add('hidden');
            document.getElementById('userIdInput').value = '';
        }

        function resetAllData() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                localStorage.clear();
                initStorage();
                renderAdminScreen();
                alert('æ‰€æœ‰è³‡æ–™å·²æ¸…é™¤');
            }
        }

        // ==================== ä»»å‹™çµ±è¨ˆé‚è¼¯ ====================
        function calculateUserTaskProgress(userId, taskEvent) {
            const registrations = getRegistrations();
            const events = getEvents();

            const taskStartTime = taskEvent.startTime ? new Date(taskEvent.startTime).getTime() : 0;
            const taskEndTime = taskEvent.endTime ? new Date(taskEvent.endTime).getTime() : Infinity;

            let count = 0;
            registrations.forEach(reg => {
                if (reg.userName !== userId) return;

                const event = events.find(e => e.id === reg.eventId);
                if (!event || event.type === 'Task') return;

                // æª¢æŸ¥æ´»å‹•æ˜¯å¦åœ¨ä»»å‹™æ™‚é–“å€é–“å…§
                let activityTime = null;
                if (event.type === 'Online' && reg.status === 'approved') {
                    activityTime = reg.approvedTime ? new Date(reg.approvedTime).getTime() : new Date(reg.timestamp).getTime();
                    if (activityTime >= taskStartTime && activityTime <= taskEndTime) {
                        count++;
                    }
                } else if (event.type === 'OnSite' && reg.status === 'approved' && reg.checkedIn) {
                    activityTime = reg.checkedInTime ? new Date(reg.checkedInTime).getTime() : new Date(reg.timestamp).getTime();
                    if (activityTime >= taskStartTime && activityTime <= taskEndTime) {
                        count++;
                    }
                }
            });

            return count;
        }

        // ==================== ç®¡ç†è€…ä»‹é¢ ====================
        function renderAdminScreen() {
            const events = getEvents();
            const registrations = getRegistrations();

            // çµ±è¨ˆæ•¸æ“š
            document.getElementById('totalEvents').textContent = events.length;
            document.getElementById('totalRegistrations').textContent = registrations.length;
            document.getElementById('pendingApprovals').textContent =
                registrations.filter(r => r.status === 'pending').length;

            // æ´»å‹•åˆ—è¡¨
            const container = document.getElementById('adminEventsList');
            container.innerHTML = '';

            events.forEach(event => {
                const card = document.createElement('div');
                card.className = 'admin-table';

                const eventRegs = registrations.filter(r => r.eventId === event.id);

                let typeInfo = '';
                if (event.type === 'Online') {
                    typeInfo = `<p>ğŸ“ é€£çµ: ${event.link || 'æœªè¨­å®š'}</p>
                                <p>ğŸ æŠ½çåé¡: ${event.drawSlots || 0}</p>
                                <p>â° æŠ½çé–‹å§‹: ${event.drawTime ? new Date(event.drawTime).toLocaleString('zh-TW') : 'æœªè¨­å®š'}</p>`;
                } else if (event.type === 'OnSite') {
                    typeInfo = `<p>ğŸ“ åœ°é»: ${event.location || 'æœªè¨­å®š'}</p>
                                <p>ğŸ“… å ±åæ™‚é–“: ${event.registrationStartTime ? new Date(event.registrationStartTime).toLocaleString('zh-TW') : 'æœªè¨­å®š'} ~ ${event.registrationEndTime ? new Date(event.registrationEndTime).toLocaleString('zh-TW') : 'æœªè¨­å®š'}</p>
                                <p>â° ç°½åˆ°æ™‚é–“: ${event.checkinStartTime ? new Date(event.checkinStartTime).toLocaleString('zh-TW') : 'æœªè¨­å®š'} ~ ${event.checkinEndTime ? new Date(event.checkinEndTime).toLocaleString('zh-TW') : 'æœªè¨­å®š'}</p>`;
                } else if (event.type === 'Task') {
                    typeInfo = `<p>ğŸ“… ä»»å‹™æ™‚é–“: ${event.startTime ? new Date(event.startTime).toLocaleString('zh-TW') : 'æœªè¨­å®š'} ~ ${event.endTime ? new Date(event.endTime).toLocaleString('zh-TW') : 'æœªè¨­å®š'}</p>
                                <p>ğŸ¯ ç›®æ¨™æ¬¡æ•¸: ${event.taskGoal}</p>
                                <p>â­ çå‹µé»æ•¸: ${event.taskPoints}</p>`;
                }

                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
                        <div>
                            <h3 style="color: #667eea;">${event.title}</h3>
                            <span class="card-badge badge-${event.type.toLowerCase()}">${event.type}</span>
                            <p style="color: #718096; margin-top: 10px;">${event.description}</p>
                            ${typeInfo}
                            ${event.type === 'Online' && event.registrationEndTime ? `<p style="color: #9ca3af; font-size: 12px;">ğŸ• å ±åæˆªæ­¢: ${new Date(event.registrationEndTime).toLocaleString('zh-TW')}</p>` : ''}
                        </div>
                        <div style="display: flex; gap: 10px;">
                            ${event.type !== 'Task' ? `
                                <button class="btn btn-primary" onclick="viewRegistrations('${event.id}')">
                                    å ±åæ˜ç´° (${eventRegs.length})
                                </button>
                                ${event.type === 'Online' && event.drawSlots > 0 ? (() => {
                                    const canDraw = !event.registrationEndTime || new Date() >= new Date(event.registrationEndTime);
                                    const drawExecuted = event.lastDrawTime;
                                    const btnDisabled = !canDraw || drawExecuted;
                                    const tooltipText = drawExecuted ? 'æŠ½çå·²åŸ·è¡Œ' :
                                                       !canDraw ? `å ±åå°šæœªçµæŸï¼ˆæˆªæ­¢æ™‚é–“ï¼š${new Date(event.registrationEndTime).toLocaleString('zh-TW')}ï¼‰` :
                                                       'å¯åŸ·è¡ŒæŠ½ç';
                                    return `
                                        <div class="tooltip">
                                            <button class="btn btn-warning" onclick="executeDraw('${event.id}')" ${btnDisabled ? 'disabled' : ''}>åŸ·è¡ŒæŠ½ç</button>
                                            <span class="tooltiptext">${tooltipText}</span>
                                        </div>
                                    `;
                                })() : ''}
                            ` : '<span style="color: #9ca3af;">ï¼ˆç³»çµ±è‡ªå‹•çµ±è¨ˆï¼‰</span>'}
                            <button class="btn btn-secondary" onclick="editEvent('${event.id}')">ç·¨è¼¯</button>
                            <button class="btn btn-danger" onclick="deleteEvent('${event.id}')">åˆªé™¤</button>
                        </div>
                    </div>
                `;

                container.appendChild(card);
            });
        }

        function showAddEventModal() {
            document.getElementById('modalTitle').textContent = 'æ–°å¢æ´»å‹•';
            document.getElementById('eventForm').reset();
            document.getElementById('editEventId').value = '';
            handleEventTypeChange();
            document.getElementById('eventModal').classList.add('active');
        }

        function editEvent(eventId) {
            const events = getEvents();
            const event = events.find(e => e.id === eventId);
            if (!event) return;

            document.getElementById('modalTitle').textContent = 'ç·¨è¼¯æ´»å‹•';
            document.getElementById('editEventId').value = eventId;
            document.getElementById('eventType').value = event.type;
            document.getElementById('eventTitle').value = event.title;
            document.getElementById('eventDescription').value = event.description;

            if (event.type === 'Online') {
                document.getElementById('eventLink').value = event.link || '';
                document.getElementById('onlineRegistrationStartTime').value = event.registrationStartTime || '';
                document.getElementById('onlineRegistrationEndTime').value = event.registrationEndTime || '';
                document.getElementById('drawSlots').value = event.drawSlots || 0;
                document.getElementById('drawTime').value = event.drawTime || '';
            } else if (event.type === 'OnSite') {
                document.getElementById('eventLocation').value = event.location || '';
                document.getElementById('registrationStartTime').value = event.registrationStartTime || '';
                document.getElementById('registrationEndTime').value = event.registrationEndTime || '';
                document.getElementById('checkinStartTime').value = event.checkinStartTime || '';
                document.getElementById('checkinEndTime').value = event.checkinEndTime || '';
            } else if (event.type === 'Task') {
                document.getElementById('taskStartTime').value = event.startTime || '';
                document.getElementById('taskEndTime').value = event.endTime || '';
                document.getElementById('taskGoal').value = event.taskGoal || 5;
                document.getElementById('taskPoints').value = event.taskPoints || 100;
            }

            handleEventTypeChange();
            document.getElementById('eventModal').classList.add('active');
        }

        function deleteEvent(eventId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ´»å‹•å—ï¼Ÿ')) return;

            let events = getEvents();
            events = events.filter(e => e.id !== eventId);
            saveEvents(events);

            // åˆªé™¤ç›¸é—œå ±å
            let registrations = getRegistrations();
            registrations = registrations.filter(r => r.eventId !== eventId);
            saveRegistrations(registrations);

            renderAdminScreen();
        }

        function handleEventTypeChange() {
            const type = document.getElementById('eventType').value;
            const events = getEvents();
            const editingId = document.getElementById('editEventId').value;

            // éš±è—æ‰€æœ‰é¡å‹ç‰¹å®šæ¬„ä½
            document.querySelectorAll('.event-field').forEach(field => {
                field.classList.add('hidden');
            });

            // é¡¯ç¤ºå°æ‡‰é¡å‹æ¬„ä½
            if (type === 'Online') {
                document.querySelectorAll('.online-field').forEach(field => {
                    field.classList.remove('hidden');
                });
                document.getElementById('taskWarning').classList.add('hidden');
            } else if (type === 'OnSite') {
                document.querySelectorAll('.onsite-field').forEach(field => {
                    field.classList.remove('hidden');
                });
                document.getElementById('taskWarning').classList.add('hidden');
            } else if (type === 'Task') {
                document.querySelectorAll('.task-field').forEach(field => {
                    field.classList.remove('hidden');
                });

                // æª¢æŸ¥æ˜¯å¦å·²æœ‰ä»»å‹™ï¼ˆç·¨è¼¯æ™‚æ’é™¤è‡ªå·±ï¼‰
                const existingTask = events.find(e => e.type === 'Task' && e.id !== editingId);
                if (existingTask) {
                    document.getElementById('taskWarning').classList.remove('hidden');
                } else {
                    document.getElementById('taskWarning').classList.add('hidden');
                }
            }
        }

        function closeEventModal() {
            document.getElementById('eventModal').classList.remove('active');
        }

        document.getElementById('eventForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const events = getEvents();
            const editingId = document.getElementById('editEventId').value;
            const type = document.getElementById('eventType').value;

            // æª¢æŸ¥ä»»å‹™å”¯ä¸€æ€§
            if (type === 'Task' && !editingId) {
                const existingTask = events.find(e => e.type === 'Task');
                if (existingTask) {
                    alert('ç³»çµ±å·²å­˜åœ¨ä¸€å€‹ä»»å‹™ç´¯ç©æ´»å‹•ï¼Œç„¡æ³•æ–°å¢ç¬¬äºŒå€‹ï¼');
                    return;
                }
            }

            const eventData = {
                id: editingId || 'evt_' + Date.now(),
                type: type,
                title: document.getElementById('eventTitle').value,
                description: document.getElementById('eventDescription').value,
            };

            if (type === 'Online') {
                eventData.link = document.getElementById('eventLink').value;
                eventData.registrationStartTime = document.getElementById('onlineRegistrationStartTime').value;
                eventData.registrationEndTime = document.getElementById('onlineRegistrationEndTime').value;
                eventData.drawSlots = parseInt(document.getElementById('drawSlots').value) || 0;
                eventData.drawTime = document.getElementById('drawTime').value;
                eventData.lastDrawTime = editingId ? events.find(e => e.id === editingId)?.lastDrawTime || '' : '';
            } else if (type === 'OnSite') {
                eventData.location = document.getElementById('eventLocation').value;
                eventData.registrationStartTime = document.getElementById('registrationStartTime').value;
                eventData.registrationEndTime = document.getElementById('registrationEndTime').value;
                eventData.checkinStartTime = document.getElementById('checkinStartTime').value;
                eventData.checkinEndTime = document.getElementById('checkinEndTime').value;
            } else if (type === 'Task') {
                eventData.startTime = document.getElementById('taskStartTime').value;
                eventData.endTime = document.getElementById('taskEndTime').value;
                eventData.taskGoal = parseInt(document.getElementById('taskGoal').value) || 5;
                eventData.taskPoints = parseInt(document.getElementById('taskPoints').value) || 100;
            }

            if (editingId) {
                const index = events.findIndex(e => e.id === editingId);
                events[index] = eventData;
            } else {
                events.push(eventData);
            }

            saveEvents(events);
            closeEventModal();
            renderAdminScreen();
        });

        // ==================== å ±åç®¡ç† ====================
        function viewRegistrations(eventId) {
            const events = getEvents();
            const event = events.find(e => e.id === eventId);
            if (!event) return;

            const registrations = getRegistrations().filter(r => r.eventId === eventId);

            let html = '<div class="admin-table"><table><thead><tr>';
            html += '<th>ä½¿ç”¨è€… ID</th>';
            html += '<th>å ±åæ™‚é–“</th>';
            html += '<th>ç‹€æ…‹</th>';
            if (event.type === 'OnSite') {
                html += '<th>æ ¸å‡†æ™‚é–“</th>';
                html += '<th>ç°½åˆ°ç‹€æ…‹</th>';
                html += '<th>ç°½åˆ°æ™‚é–“</th>';
            }
            html += '<th>ä¸­ç</th>';
            html += '<th>æ“ä½œ</th>';
            html += '</tr></thead><tbody>';

            registrations.forEach(reg => {
                html += '<tr>';
                html += `<td>${reg.userName}</td>`;
                html += `<td>${new Date(reg.timestamp).toLocaleString('zh-TW')}</td>`;
                html += `<td><span class="status-badge status-${reg.status}">${
                    reg.status === 'pending' ? 'å¾…å¯©æ ¸' :
                    reg.status === 'approved' ? 'å·²æ ¸å‡†' : 'å·²æ‹’çµ•'
                }</span></td>`;

                if (event.type === 'OnSite') {
                    html += `<td>${reg.approvedTime ? new Date(reg.approvedTime).toLocaleString('zh-TW') : '-'}</td>`;
                    html += `<td>${reg.checkedIn ? 'âœ… å·²ç°½åˆ°' : 'â³ æœªç°½åˆ°'}</td>`;
                    html += `<td>${reg.checkedInTime ? new Date(reg.checkedInTime).toLocaleString('zh-TW') : '-'}</td>`;
                }

                html += `<td>${reg.isWinner ? 'ğŸ‰ ä¸­ç' : '-'}</td>`;
                html += `<td>`;

                if (reg.status === 'pending') {
                    html += `<button class="btn btn-success" onclick="approveRegistration('${eventId}', '${reg.userName}')">æ ¸å‡†</button> `;
                    html += `<button class="btn btn-danger" onclick="rejectRegistration('${eventId}', '${reg.userName}')">æ‹’çµ•</button>`;
                }

                html += `</td></tr>`;
            });

            html += '</tbody></table></div>';

            document.getElementById('registrationsContent').innerHTML = html;
            document.getElementById('registrationsModal').classList.add('active');
        }

        function closeRegistrationsModal() {
            document.getElementById('registrationsModal').classList.remove('active');
        }

        function approveRegistration(eventId, userName) {
            const registrations = getRegistrations();
            const reg = registrations.find(r => r.eventId === eventId && r.userName === userName);
            if (reg) {
                reg.status = 'approved';
                reg.approvedTime = new Date().toISOString();
                saveRegistrations(registrations);
                viewRegistrations(eventId);
            }
        }

        function rejectRegistration(eventId, userName) {
            const registrations = getRegistrations();
            const reg = registrations.find(r => r.eventId === eventId && r.userName === userName);
            if (reg) {
                reg.status = 'rejected';
                saveRegistrations(registrations);
                viewRegistrations(eventId);
            }
        }

        // ==================== æŠ½çåŠŸèƒ½ ====================
        function executeDraw(eventId) {
            const events = getEvents();
            const event = events.find(e => e.id === eventId);
            if (!event || event.drawSlots <= 0) return;

            // æª¢æŸ¥å ±åæ˜¯å¦å·²çµæŸ
            if (event.registrationEndTime && new Date() < new Date(event.registrationEndTime)) {
                alert(`å ±åå°šæœªçµæŸï¼Œç„¡æ³•æŠ½çï¼\nå ±åæˆªæ­¢æ™‚é–“ï¼š${new Date(event.registrationEndTime).toLocaleString('zh-TW')}`);
                return;
            }

            // æª¢æŸ¥æ˜¯å¦å·²åŸ·è¡ŒéæŠ½ç
            if (event.lastDrawTime) {
                alert('æ­¤æ´»å‹•å·²åŸ·è¡ŒéæŠ½çï¼');
                return;
            }

            const registrations = getRegistrations();
            const eligibleRegs = registrations.filter(r =>
                r.eventId === eventId &&
                r.status === 'approved' &&
                !r.isWinner
            );

            if (eligibleRegs.length === 0) {
                alert('æ²’æœ‰ç¬¦åˆè³‡æ ¼çš„åƒèˆ‡è€…ï¼');
                return;
            }

            const winnerCount = Math.min(event.drawSlots, eligibleRegs.length);
            if (!confirm(`å°‡æŠ½å‡º ${winnerCount} ä½ä¸­çè€…ï¼Œç¢ºå®šåŸ·è¡Œï¼Ÿ`)) return;

            // éš¨æ©ŸæŠ½é¸
            const shuffled = eligibleRegs.sort(() => 0.5 - Math.random());
            const winners = shuffled.slice(0, winnerCount);

            winners.forEach(winner => {
                winner.isWinner = true;
            });

            // è¨˜éŒ„æŠ½çåŸ·è¡Œæ™‚é–“
            event.lastDrawTime = new Date().toISOString();
            saveEvents(events);
            saveRegistrations(registrations);

            alert(`æŠ½çå®Œæˆï¼å…± ${winnerCount} ä½ä¸­çè€…`);
            renderAdminScreen();
        }

        // ==================== ä½¿ç”¨è€…ä»‹é¢ ====================
        function isEventExpired(event) {
            const now = new Date();

            if (event.type === 'Online') {
                // Online æ´»å‹•ï¼šå¦‚æœå·²åŸ·è¡ŒæŠ½çæˆ–å ±åæ™‚é–“å·²é(å¦‚æœæœ‰è¨­å®š)
                return event.lastDrawTime !== undefined && event.lastDrawTime !== '';
            } else if (event.type === 'OnSite') {
                // OnSite æ´»å‹•ï¼šç°½åˆ°çµæŸæ™‚é–“å·²é
                if (event.checkinEndTime) {
                    return now > new Date(event.checkinEndTime);
                }
                // å¦‚æœæ²’æœ‰ç°½åˆ°æ™‚é–“ï¼Œæª¢æŸ¥å ±åçµæŸæ™‚é–“
                if (event.registrationEndTime) {
                    return now > new Date(event.registrationEndTime);
                }
            }
            return false;
        }

        function renderUserScreen() {
            const events = getEvents();
            const registrations = getRegistrations();

            // æ›´æ–°é»æ•¸é¡¯ç¤º
            const userPoints = getUserPoints(currentUser);
            document.getElementById('userPoints').textContent = userPoints;

            // ä»»å‹™é€²åº¦ Banner - åªé¡¯ç¤ºæœªéæœŸçš„ä»»å‹™
            const taskEvent = events.find(e => e.type === 'Task');
            const taskBanner = document.getElementById('taskBanner');

            if (taskEvent) {
                const now = new Date();
                const taskEnd = taskEvent.endTime ? new Date(taskEvent.endTime) : null;
                const isTaskExpired = taskEnd && now > taskEnd;

                // å¦‚æœä»»å‹™å·²éæœŸï¼Œä¸é¡¯ç¤º Banner
                if (isTaskExpired) {
                    taskBanner.classList.add('hidden');
                } else {
                    const userProgress = calculateUserTaskProgress(currentUser, taskEvent);
                    const percentage = Math.min(100, (userProgress / taskEvent.taskGoal) * 100);
                    const isCompleted = userProgress >= taskEvent.taskGoal;
                    const claims = getTaskClaims(currentUser);
                    const hasClaimed = claims[taskEvent.id];

                    const taskStart = taskEvent.startTime ? new Date(taskEvent.startTime) : null;
                    const isTaskActive = (!taskStart || now >= taskStart) && (!taskEnd || now <= taskEnd);

                    let timeInfo = '';
                    if (taskStart && taskEnd) {
                        timeInfo = `<p style="font-size: 14px;">ğŸ“… ä»»å‹™æœŸé–“: ${taskStart.toLocaleDateString('zh-TW')} ~ ${taskEnd.toLocaleDateString('zh-TW')}</p>`;
                    }

                    taskBanner.classList.remove('hidden');
                    taskBanner.innerHTML = `
                        <h3>ğŸ¯ ${taskEvent.title}</h3>
                        <p>${taskEvent.description}</p>
                        ${timeInfo}
                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: ${percentage}%">
                                ${userProgress} / ${taskEvent.taskGoal}
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <span>ç›®å‰é€²åº¦: ${userProgress} æ¬¡åƒèˆ‡</span>
                            <span>çå‹µ: ${taskEvent.taskPoints} é»</span>
                        </div>
                        ${isCompleted ? `
                            <div style="margin-top: 15px;">
                                <div class="achievement-stamp">ğŸ† ä»»å‹™é”æˆï¼</div>
                                ${!hasClaimed ? `
                                    <button class="btn btn-claim" onclick="claimTaskReward('${taskEvent.id}', ${taskEvent.taskPoints})" style="margin-top: 10px;">
                                        ğŸ é ˜å– ${taskEvent.taskPoints} é»çå‹µ
                                    </button>
                                ` : '<p style="color: #ffd700; margin-top: 10px;">âœ… çå‹µå·²é ˜å–</p>'}
                            </div>
                        ` : ''}
                        ${!isTaskActive ? '<p style="color: #ffd700; margin-top: 10px;">â° ä»»å‹™å°šæœªé–‹å§‹</p>' : ''}
                    `;
                }
            } else {
                taskBanner.classList.add('hidden');
            }

            // æ´»å‹•åˆ—è¡¨ - åˆ†ç‚ºé€²è¡Œä¸­å’Œæ­·å²
            const container = document.getElementById('userEventsList');
            const historyContainer = document.getElementById('historyEventsList');
            const historySection = document.getElementById('historySection');
            container.innerHTML = '';
            historyContainer.innerHTML = '';

            const userEvents = events.filter(e => e.type !== 'Task');
            const activeEvents = userEvents.filter(e => !isEventExpired(e));
            const expiredEvents = userEvents.filter(e => isEventExpired(e));

            // æ¸²æŸ“é€²è¡Œä¸­çš„æ´»å‹•
            activeEvents.forEach(event => {
                const userReg = registrations.find(r =>
                    r.eventId === event.id && r.userName === currentUser
                );

                const card = document.createElement('div');
                card.className = 'card';

                let statusInfo = '';
                let actionButtons = '';

                if (userReg) {
                    if (userReg.isWinner) {
                        statusInfo = '<div class="winner-badge">ğŸ‰ æ‚¨å·²ä¸­çï¼</div>';
                    }

                    if (userReg.status === 'pending') {
                        statusInfo += '<div class="info-text">â³ ç­‰å¾…å¯©æ ¸ä¸­...</div>';
                        if (event.type === 'OnSite') {
                            actionButtons = `<button class="btn btn-danger" onclick="cancelRegistration('${event.id}')">å–æ¶ˆå ±å</button>`;
                        }
                    } else if (userReg.status === 'approved') {
                        statusInfo += '<div class="info-text">âœ… å ±åå·²æ ¸å‡†</div>';
                        if (userReg.approvedTime) {
                            statusInfo += `<div class="card-content" style="margin: 5px 0; font-size: 12px;">æ ¸å‡†æ™‚é–“: ${new Date(userReg.approvedTime).toLocaleString('zh-TW')}</div>`;
                        }

                        if (event.type === 'OnSite' && !userReg.checkedIn) {
                            actionButtons = `<button class="btn btn-success" onclick="checkIn('${event.id}')">ğŸ“ ç°½åˆ°</button>`;
                        } else if (event.type === 'OnSite' && userReg.checkedIn) {
                            statusInfo += '<div class="info-text">âœ… å·²å®Œæˆç°½åˆ°</div>';
                            if (userReg.checkedInTime) {
                                statusInfo += `<div class="card-content" style="margin: 5px 0; font-size: 12px;">ç°½åˆ°æ™‚é–“: ${new Date(userReg.checkedInTime).toLocaleString('zh-TW')}</div>`;
                            }
                        }
                    } else if (userReg.status === 'rejected') {
                        statusInfo += '<div class="warning-text">âŒ å ±åæœªé€šé</div>';
                    }
                } else {
                    actionButtons = `<button class="btn btn-primary" onclick="registerEvent('${event.id}')">å ±ååƒåŠ </button>`;
                }

                actionButtons += ` <button class="btn btn-secondary" onclick="viewEventDetail('${event.id}')">æŸ¥çœ‹è©³æƒ…</button>`;

                card.innerHTML = `
                    <div class="card-header">
                        <div class="card-title">${event.title}</div>
                        <span class="card-badge badge-${event.type.toLowerCase()}">${event.type}</span>
                    </div>
                    ${statusInfo}
                    <div class="card-content">${event.description}</div>
                    <div class="card-actions">${actionButtons}</div>
                `;

                container.appendChild(card);
            });

            // æ¸²æŸ“æ­·å²æ´»å‹•
            if (expiredEvents.length > 0) {
                historySection.classList.remove('hidden');

                expiredEvents.forEach(event => {
                    const userReg = registrations.find(r =>
                        r.eventId === event.id && r.userName === currentUser
                    );

                    const card = document.createElement('div');
                    card.className = 'card';
                    card.style.opacity = '0.85'; // æ­·å²æ´»å‹•ç¨å¾®åŠé€æ˜

                    let statusInfo = '<div class="warning-text">ğŸ“… æ´»å‹•å·²çµæŸ</div>';
                    let actionButtons = '';

                    if (userReg) {
                        // ä¸­çèˆ‡æœªä¸­çæç¤ºï¼ˆOnline æ´»å‹•å°ˆç”¨ï¼‰
                        if (event.type === 'Online' && event.lastDrawTime) {
                            if (userReg.isWinner) {
                                statusInfo += '<div class="winner-badge">ğŸ‰ æ‚¨å·²ä¸­çï¼</div>';
                            } else if (userReg.status === 'approved') {
                                statusInfo += '<div class="info-text" style="background: #fff3cd; border-left-color: #ffc107; color: #856404;">ğŸ’” æœªä¸­ç</div>';
                            }
                        } else if (userReg.isWinner) {
                            statusInfo += '<div class="winner-badge">ğŸ‰ æ‚¨å·²ä¸­çï¼</div>';
                        }

                        if (userReg.status === 'approved') {
                            statusInfo += '<div class="info-text">âœ… å·²åƒèˆ‡æ­¤æ´»å‹•</div>';
                            if (userReg.approvedTime) {
                                statusInfo += `<div class="card-content" style="margin: 5px 0; font-size: 12px;">æ ¸å‡†æ™‚é–“: ${new Date(userReg.approvedTime).toLocaleString('zh-TW')}</div>`;
                            }
                            if (event.type === 'OnSite' && userReg.checkedIn && userReg.checkedInTime) {
                                statusInfo += `<div class="card-content" style="margin: 5px 0; font-size: 12px;">ç°½åˆ°æ™‚é–“: ${new Date(userReg.checkedInTime).toLocaleString('zh-TW')}</div>`;
                            }
                        } else if (userReg.status === 'rejected') {
                            statusInfo += '<div class="warning-text">âŒ å ±åæœªé€šé</div>';
                        } else if (userReg.status === 'pending') {
                            statusInfo += '<div class="warning-text">â³ å¯©æ ¸æœªå®Œæˆ</div>';
                        }
                    }

                    actionButtons = `<button class="btn btn-secondary" onclick="viewEventDetail('${event.id}')">æŸ¥çœ‹è©³æƒ…</button>`;

                    card.innerHTML = `
                        <div class="card-header">
                            <div class="card-title">${event.title}</div>
                            <span class="card-badge badge-${event.type.toLowerCase()}">${event.type}</span>
                        </div>
                        ${statusInfo}
                        <div class="card-content">${event.description}</div>
                        <div class="card-actions">${actionButtons}</div>
                    `;

                    historyContainer.appendChild(card);
                });
            } else {
                historySection.classList.add('hidden');
            }
        }

        function claimTaskReward(taskId, points) {
            const claims = getTaskClaims(currentUser);
            if (claims[taskId]) {
                alert('æ‚¨å·²ç¶“é ˜å–éæ­¤ä»»å‹™çš„çå‹µï¼');
                return;
            }

            // è¨˜éŒ„é ˜å–
            saveTaskClaim(currentUser, taskId);

            // å¢åŠ é»æ•¸
            const currentPoints = getUserPoints(currentUser);
            saveUserPoints(currentUser, currentPoints + points);

            alert(`æ­å–œï¼æˆåŠŸé ˜å– ${points} é»çå‹µï¼`);
            renderUserScreen();
        }

        function registerEvent(eventId) {
            const events = getEvents();
            const event = events.find(e => e.id === eventId);
            if (!event) return;

            const registrations = getRegistrations();

            // æª¢æŸ¥æ˜¯å¦å·²å ±å
            const existing = registrations.find(r =>
                r.eventId === eventId && r.userName === currentUser
            );

            if (existing) {
                alert('æ‚¨å·²ç¶“å ±åéæ­¤æ´»å‹•ï¼');
                return;
            }

            const now = new Date();

            // Online æ´»å‹•æª¢æŸ¥å ±åæ™‚é–“
            if (event.type === 'Online') {
                if (event.registrationStartTime && now < new Date(event.registrationStartTime)) {
                    alert(`å ±åå°šæœªé–‹å§‹ï¼\né–‹å§‹æ™‚é–“ï¼š${new Date(event.registrationStartTime).toLocaleString('zh-TW')}`);
                    return;
                }
                if (event.registrationEndTime && now > new Date(event.registrationEndTime)) {
                    alert(`å ±åå·²æˆªæ­¢ï¼\næˆªæ­¢æ™‚é–“ï¼š${new Date(event.registrationEndTime).toLocaleString('zh-TW')}`);
                    return;
                }
            }

            // OnSite æ´»å‹•æª¢æŸ¥å ±åæ™‚é–“
            if (event.type === 'OnSite') {
                if (event.registrationStartTime && now < new Date(event.registrationStartTime)) {
                    alert(`å ±åå°šæœªé–‹å§‹ï¼\né–‹å§‹æ™‚é–“ï¼š${new Date(event.registrationStartTime).toLocaleString('zh-TW')}`);
                    return;
                }
                if (event.registrationEndTime && now > new Date(event.registrationEndTime)) {
                    alert(`å ±åå·²æˆªæ­¢ï¼\næˆªæ­¢æ™‚é–“ï¼š${new Date(event.registrationEndTime).toLocaleString('zh-TW')}`);
                    return;
                }
            }

            const registration = {
                eventId: eventId,
                userName: currentUser,
                timestamp: new Date().toISOString(),
                status: event.type === 'Online' ? 'approved' : 'pending',
                checkedIn: false,
                isWinner: false,
                approvedTime: event.type === 'Online' ? new Date().toISOString() : null
            };

            registrations.push(registration);
            saveRegistrations(registrations);

            if (event.type === 'Online') {
                alert('å ±åæˆåŠŸï¼');
            } else {
                alert('å ±åæˆåŠŸï¼ç­‰å¾…ç®¡ç†è€…å¯©æ ¸');
            }

            renderUserScreen();
        }

        function cancelRegistration(eventId) {
            const registrations = getRegistrations();
            const regIndex = registrations.findIndex(r =>
                r.eventId === eventId && r.userName === currentUser
            );

            if (regIndex === -1) return;

            const reg = registrations[regIndex];

            if (reg.status === 'approved') {
                alert('å ±åå·²æ ¸å‡†ï¼Œç„¡æ³•å–æ¶ˆï¼');
                return;
            }

            if (confirm('ç¢ºå®šè¦å–æ¶ˆå ±åå—ï¼Ÿ')) {
                registrations.splice(regIndex, 1);
                saveRegistrations(registrations);
                alert('å·²å–æ¶ˆå ±å');
                renderUserScreen();
            }
        }

        function checkIn(eventId) {
            const events = getEvents();
            const event = events.find(e => e.id === eventId);
            if (!event) return;

            const registrations = getRegistrations();
            const reg = registrations.find(r =>
                r.eventId === eventId && r.userName === currentUser
            );

            if (!reg) return;

            if (reg.status !== 'approved') {
                alert('å ±åå°šæœªæ ¸å‡†ï¼Œç„¡æ³•ç°½åˆ°ï¼');
                return;
            }

            // æª¢æŸ¥ç°½åˆ°æ™‚é–“
            const now = new Date();
            if (event.checkinStartTime && now < new Date(event.checkinStartTime)) {
                alert(`ç°½åˆ°å°šæœªé–‹å§‹ï¼\né–‹å§‹æ™‚é–“ï¼š${new Date(event.checkinStartTime).toLocaleString('zh-TW')}`);
                return;
            }
            if (event.checkinEndTime && now > new Date(event.checkinEndTime)) {
                alert(`ç°½åˆ°å·²æˆªæ­¢ï¼\næˆªæ­¢æ™‚é–“ï¼š${new Date(event.checkinEndTime).toLocaleString('zh-TW')}`);
                return;
            }

            reg.checkedIn = true;
            reg.checkedInTime = new Date().toISOString();
            saveRegistrations(registrations);
            alert('ç°½åˆ°æˆåŠŸï¼');
            renderUserScreen();
        }

        function viewEventDetail(eventId) {
            const events = getEvents();
            const event = events.find(e => e.id === eventId);
            if (!event) return;

            const registrations = getRegistrations();
            const userReg = registrations.find(r =>
                r.eventId === eventId && r.userName === currentUser
            );

            document.getElementById('detailTitle').textContent = event.title;

            let html = `<div class="card-content">`;
            html += `<p><strong>é¡å‹ï¼š</strong><span class="card-badge badge-${event.type.toLowerCase()}">${event.type}</span></p>`;
            html += `<p><strong>èªªæ˜ï¼š</strong>${event.description}</p>`;

            if (event.type === 'Online') {
                if (userReg && userReg.status === 'approved' && event.link) {
                    html += `<p><strong>ğŸ“ é€£çµï¼š</strong><a href="${event.link}" target="_blank">${event.link}</a></p>`;
                } else if (!userReg || userReg.status !== 'approved') {
                    html += `<p class="info-text">é€£çµå°‡åœ¨å ±åæ ¸å‡†å¾Œé¡¯ç¤º</p>`;
                }
                if (event.drawSlots > 0) {
                    html += `<p><strong>ğŸ æŠ½çåé¡ï¼š</strong>${event.drawSlots} å</p>`;
                    if (event.drawTime) {
                        html += `<p><strong>â° æŠ½çæ™‚é–“ï¼š</strong>${new Date(event.drawTime).toLocaleString('zh-TW')}</p>`;
                    }
                }
            } else if (event.type === 'OnSite') {
                html += `<p><strong>ğŸ“ åœ°é»ï¼š</strong>${event.location || 'æœªè¨­å®š'}</p>`;
                if (event.registrationStartTime && event.registrationEndTime) {
                    html += `<p><strong>ğŸ“… å ±åæ™‚é–“ï¼š</strong>${new Date(event.registrationStartTime).toLocaleString('zh-TW')} ~ ${new Date(event.registrationEndTime).toLocaleString('zh-TW')}</p>`;
                }
                if (event.checkinStartTime && event.checkinEndTime) {
                    html += `<p><strong>â° ç°½åˆ°æ™‚é–“ï¼š</strong>${new Date(event.checkinStartTime).toLocaleString('zh-TW')} ~ ${new Date(event.checkinEndTime).toLocaleString('zh-TW')}</p>`;
                }
            }

            // é¡¯ç¤ºä½¿ç”¨è€…çš„å ±åç‹€æ…‹
            if (userReg) {
                html += `<hr style="margin: 15px 0; border: none; border-top: 1px solid #e2e8f0;">`;
                html += `<p><strong>ğŸ“‹ æ‚¨çš„å ±åç‹€æ…‹ï¼š</strong></p>`;
                html += `<p>å ±åæ™‚é–“: ${new Date(userReg.timestamp).toLocaleString('zh-TW')}</p>`;
                if (userReg.approvedTime) {
                    html += `<p>æ ¸å‡†æ™‚é–“: ${new Date(userReg.approvedTime).toLocaleString('zh-TW')}</p>`;
                }
                if (userReg.checkedInTime) {
                    html += `<p>ç°½åˆ°æ™‚é–“: ${new Date(userReg.checkedInTime).toLocaleString('zh-TW')}</p>`;
                }
            }

            // é¡¯ç¤ºä¸­çåå–®ï¼ˆé®ç½©è™•ç†ï¼‰
            const winners = registrations.filter(r => r.eventId === eventId && r.isWinner);
            if (winners.length > 0) {
                html += `<div class="info-text">`;
                html += `<strong>ğŸ‰ ä¸­çåå–®ï¼š</strong><br>`;
                winners.forEach(w => {
                    const masked = maskUserId(w.userName);
                    html += `${masked}<br>`;
                });
                html += `</div>`;
            }

            html += `</div>`;

            document.getElementById('eventDetailContent').innerHTML = html;
            document.getElementById('eventDetailModal').classList.add('active');
        }

        function closeEventDetailModal() {
            document.getElementById('eventDetailModal').classList.remove('active');
        }

        function maskUserId(userId) {
            if (userId.length <= 2) return userId;
            const first = userId[0];
            const last = userId[userId.length - 1];
            const stars = '*'.repeat(Math.min(4, userId.length - 2));
            return first + stars + last;
        }

        // ==================== åˆå§‹åŒ– ====================
        initStorage();
    </script>
</body>
</html>
