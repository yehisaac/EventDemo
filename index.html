<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>活動報名與任務累積系統 v3.0.0</title>

    <!-- 外部 CSS -->
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <!-- 登入畫面 -->
        <div id="loginScreen" class="login-screen">
            <h1>🎯 活動報名系統</h1>
            <p style="text-align: center; color: #718096; margin-bottom: 30px;">
                OMO (Online-Merge-Offline) 活動管理平台 v3.0.0
            </p>
            <div class="form-group">
                <label for="userIdInput">使用者 ID (User 登入用):</label>
                <input type="text" id="userIdInput" placeholder="請輸入您的 ID">
            </div>
            <div class="login-buttons">
                <button class="btn-admin" onclick="loginAsAdmin()">管理者登入</button>
                <button class="btn-user" onclick="loginAsUser()">使用者登入</button>
            </div>
        </div>

        <!-- 管理者介面 -->
        <div id="adminScreen" class="hidden">
            <div class="header">
                <h2>📊 管理者控制台</h2>
                <div class="user-info">
                    <button class="btn reset-btn" onclick="resetAllData()">🗑️ 清除所有資料</button>
                    <button class="btn btn-secondary" onclick="logout()">登出</button>
                </div>
            </div>

            <!-- 統計卡片 -->
            <div class="stats-card">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalEvents">0</div>
                        <div class="stat-label">總活動數</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalRegistrations">0</div>
                        <div class="stat-label">總報名數</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="pendingApprovals">0</div>
                        <div class="stat-label">待審核</div>
                    </div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="showAddEventModal()">➕ 新增活動</button>

            <!-- 活動分類頁籤 -->
            <div class="tabs-container">
                <div class="tabs-nav">
                    <button class="tab-button active" onclick="switchTab('online')">
                        📡 線上活動 <span class="tab-badge" id="onlineCount">0</span>
                    </button>
                    <button class="tab-button" onclick="switchTab('onsite')">
                        📍 實體活動 <span class="tab-badge" id="onsiteCount">0</span>
                    </button>
                    <button class="tab-button" onclick="switchTab('task')">
                        🎯 任務活動 <span class="tab-badge" id="taskCount">0</span>
                    </button>
                </div>

                <div id="tab-online" class="tab-content active">
                    <div id="onlineEventsList"></div>
                </div>

                <div id="tab-onsite" class="tab-content">
                    <div id="onsiteEventsList"></div>
                </div>

                <div id="tab-task" class="tab-content">
                    <div id="taskEventsList"></div>
                </div>
            </div>
        </div>

        <!-- 使用者介面 -->
        <div id="userScreen" class="hidden">
            <div class="header">
                <h2>🎉 我的活動</h2>
                <div class="user-info">
                    <span class="points-display">⭐ <span id="userPoints">0</span> 點</span>
                    <span style="color: #718096; margin-left: 10px;">使用者：<strong id="currentUserDisplay"></strong></span>
                    <button class="btn btn-secondary" onclick="logout()">登出</button>
                </div>
            </div>

            <!-- 任務進度 Banner -->
            <div id="taskBanner" class="task-banner hidden"></div>

            <!-- 進行中的活動 -->
            <h3 style="color: white; margin: 20px 0 10px 0;">📅 進行中的活動</h3>
            <div id="userEventsList" class="cards-grid"></div>

            <!-- 歷史活動 -->
            <div id="historySection" class="hidden" style="margin-top: 40px;">
                <h3 style="color: white; margin: 20px 0 10px 0;">📚 歷史活動</h3>
                <div id="historyEventsList" class="cards-grid" style="opacity: 0.85;"></div>
            </div>
        </div>
    </div>

    <!-- 活動編輯 Modal -->
    <div id="eventModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">新增活動</h3>
                <button class="close-btn" onclick="closeEventModal()">×</button>
            </div>
            <form id="eventForm">
                <input type="hidden" id="eventIdInput">

                <div class="form-group">
                    <label>活動類型：</label>
                    <select id="eventType" onchange="handleEventTypeChange()" required>
                        <option value="Online">Online 線上活動</option>
                        <option value="OnSite">OnSite 實體活動</option>
                        <option value="Task">Task 任務累積</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>活動標題：</label>
                    <input type="text" id="eventTitle" required>
                </div>

                <div class="form-group">
                    <label>活動說明：</label>
                    <textarea id="eventDescription" rows="3" required></textarea>
                </div>

                <!-- Online 專屬欄位 -->
                <div class="form-group event-field online-field">
                    <label>連結 (選填)：</label>
                    <input type="text" id="eventLink" placeholder="視訊會議、線上資源連結等">
                </div>

                <div class="form-group event-field online-field">
                    <label>報名開始時間：</label>
                    <input type="datetime-local" id="onlineRegistrationStartTime">
                </div>

                <div class="form-group event-field online-field">
                    <label>報名結束時間：</label>
                    <input type="datetime-local" id="onlineRegistrationEndTime">
                </div>

                <div class="form-group event-field online-field">
                    <label>報名人數上限：</label>
                    <input type="number" id="onlineMaxParticipants" min="0" value="0" placeholder="0 = 無限制">
                    <small style="color: #718096;">0 表示無限制</small>
                </div>

                <div class="form-group event-field online-field">
                    <label>抽獎名額：</label>
                    <input type="number" id="drawSlots" min="0" value="0">
                </div>

                <!-- OnSite 專屬欄位 -->
                <div class="form-group event-field onsite-field hidden">
                    <label>活動地點：</label>
                    <input type="text" id="eventLocation">
                </div>

                <div class="form-group event-field onsite-field hidden">
                    <label>報名開始時間：</label>
                    <input type="datetime-local" id="registrationStartTime">
                </div>

                <div class="form-group event-field onsite-field hidden">
                    <label>報名結束時間：</label>
                    <input type="datetime-local" id="registrationEndTime">
                </div>

                <div class="form-group event-field onsite-field hidden">
                    <label>報名人數上限：</label>
                    <input type="number" id="onsiteMaxParticipants" min="0" value="0" placeholder="0 = 無限制">
                    <small style="color: #718096;">0 表示無限制，超過上限自動進入候補名單</small>
                </div>

                <div class="form-group event-field onsite-field hidden">
                    <label>簽到開始時間：</label>
                    <input type="datetime-local" id="checkinStartTime">
                </div>

                <div class="form-group event-field onsite-field hidden">
                    <label>簽到結束時間：</label>
                    <input type="datetime-local" id="checkinEndTime">
                </div>

                <div class="form-group event-field onsite-field hidden">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="checkinCodeEnabled">
                        <span>啟用動態簽到碼（每30秒刷新）</span>
                    </label>
                    <small style="color: #718096;">啟用後，使用者需輸入簽到碼或掃描 QR Code 簽到</small>
                </div>

                <!-- Hybrid 混合模式（OnSite 專屬） -->
                <div class="form-group event-field onsite-field hidden">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="allowOnlineView" onchange="toggleOnlineLink()">
                        <span>🌐 啟用 Hybrid 混合模式（線上＋實體）</span>
                    </label>
                    <small style="color: #718096;">允許使用者選擇線上或實體參與</small>
                </div>

                <div class="form-group event-field onsite-field hidden" id="onlineLinkField" style="display: none;">
                    <label>線上連結：</label>
                    <input type="text" id="onlineLink" placeholder="視訊會議、直播連結等">
                    <small style="color: #718096;">線上參與者將看到此連結</small>
                </div>

                <div class="form-group event-field onsite-field hidden" id="countOnlineField" style="display: none;">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="countOnlineForTask">
                        <span>線上參與者計入任務統計</span>
                    </label>
                    <small style="color: #718096;">勾選後，線上參與者（無需簽到）也會計入任務累積</small>
                </div>

                <!-- Task 專屬欄位 -->
                <div class="form-group event-field task-field hidden">
                    <label>任務開始時間：</label>
                    <input type="datetime-local" id="taskStartTime">
                </div>

                <div class="form-group event-field task-field hidden">
                    <label>任務結束時間：</label>
                    <input type="datetime-local" id="taskEndTime">
                </div>

                <div class="form-group event-field task-field hidden">
                    <label>目標參加次數：</label>
                    <input type="number" id="taskGoal" min="1" value="5">
                </div>

                <div class="form-group event-field task-field hidden">
                    <label>獎勵點數：</label>
                    <input type="number" id="taskPoints" min="0" value="100">
                </div>

                <div class="warning-text task-field hidden" id="taskWarning">
                    ⚠️ 系統只能同時存在一個 Task 活動
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">儲存</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEventModal()">取消</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 報名明細 Modal -->
    <div id="registrationsModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3>報名明細</h3>
                <button class="close-btn" onclick="closeRegistrationsModal()">×</button>
            </div>
            <div id="registrationsContent"></div>
        </div>
    </div>

    <!-- 活動詳情 Modal -->
    <div id="eventDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="detailTitle"></h3>
                <button class="close-btn" onclick="closeEventDetailModal()">×</button>
            </div>
            <div id="eventDetailContent"></div>
        </div>
    </div>

    <!-- QR Code 庫（本地版本，必須在所有模組之前載入） -->
    <script src="lib/qrcode.min.js"></script>

    <!-- JavaScript 模組載入 -->
    <script src="js/config.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/waitlist.js"></script>
    <script src="js/checkin.js"></script>
    <script src="js/task.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/admin.js"></script>
    <script src="js/user.js"></script>

    <!-- 初始化 -->
    <script>
        initStorage();

        // Hybrid 模式欄位切換
        function toggleOnlineLink() {
            const allowOnlineView = document.getElementById('allowOnlineView').checked;
            const onlineLinkField = document.getElementById('onlineLinkField');
            const countOnlineField = document.getElementById('countOnlineField');

            if (allowOnlineView) {
                onlineLinkField.style.display = 'block';
                countOnlineField.style.display = 'block';
            } else {
                onlineLinkField.style.display = 'none';
                countOnlineField.style.display = 'none';
            }
        }
    </script>
</body>
</html>
